<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FOG tiny demo (local)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body{margin:0;display:flex;height:100vh;font-family:system-ui,Arial}
    #left{width:360px;padding:16px;box-shadow:2px 0 8px rgba(0,0,0,.08)}
    #log{height:40vh;overflow:auto;background:#f6f8fa;padding:8px;border:1px solid #e2e5e9}
    #view{flex:1}
    input,button,select{margin:6px 0;width:100%}
  </style>
</head>
<body>
<div id="left">
  <h3>Load RDF → OBJ</h3>
  <label>RDF URL</label>
  <input id="rdfUrl" value="http://127.0.0.1:8000/road2.ttl"/>
  <button id="loadBtn">Load</button>
  <div id="log"></div>
</div>
<canvas id="view"></canvas>

<script type="module">
  // 用 N3 解析 TTL（用 unpkg 引入）
  import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";
  import { OrbitControls } from "https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js";
  import { OBJLoader } from "https://unpkg.com/three@0.160.0/examples/jsm/loaders/OBJLoader.js";

  const log = (m)=>{const d=document.getElementById('log');d.innerHTML+=m+"<br/>";d.scrollTop=d.scrollHeight;}
  const ttlFetch = (url)=>fetch(url).then(r=>{ if(!r.ok) throw new Error(r.status); return r.text(); });

  // 极简 TTL 解析：直接正则找 fog:asObj 的字符串（只为演示，生产请用 N3 库）
  function extractObjUrl(ttlText){
    // 匹配 "http...obj"
    const m = ttlText.match(/"([^"]+\.obj)"/i);
    return m ? m[1] : null;
  }

  // Three.js 场景
  const canvas = document.getElementById('view');
  const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0xf0f2f5);
  const camera = new THREE.PerspectiveCamera(60, 2, 0.1, 10000);
  camera.position.set(50,50,80);
  const controls = new OrbitControls(camera, renderer.domElement);
  const light = new THREE.DirectionalLight(0xffffff, 1);
  light.position.set(50,100,50); scene.add(light, new THREE.AmbientLight(0xffffff, 0.6));

  function resize(){ const w=window.innerWidth-360, h=window.innerHeight; renderer.setSize(w,h,false); camera.aspect=w/h; camera.updateProjectionMatrix(); }
  window.addEventListener('resize', resize); resize();

  renderer.setAnimationLoop(()=>{ controls.update(); renderer.render(scene,camera); });

  document.getElementById('loadBtn').onclick = async ()=>{
    try{
      const url = document.getElementById('rdfUrl').value.trim();
      log(`Fetching RDF: ${url}`);
      const ttl = await ttlFetch(url);
      const objUrl = extractObjUrl(ttl);
      if(!objUrl){ log("❌ No OBJ URL found in TTL (fog:asObj)."); return; }
      log(`Found OBJ: ${objUrl}`);

      // 清空旧模型
      for(let i=scene.children.length-1;i>=0;i--){
        const o=scene.children[i]; if(o.isMesh) scene.remove(o);
      }

      // 载入 OBJ
      const loader = new OBJLoader();
      loader.load(objUrl,(obj)=>{
        scene.add(obj);
        log("✅ OBJ loaded");
      }, undefined, (e)=>{ log("❌ OBJ load error: "+e.message); });
    }catch(e){
      log("❌ "+e.message);
    }
  };
</script>
</body>
</html>
